<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Face Mapper - Live Facial Movement Mapping</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .camera-section, .detection-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            text-align: center;
            color: #fff;
            font-weight: bold;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #video {
            width: 100%;
            height: 400px;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .image-preview-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(45deg, #2c3e50, #4ca1af);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        #mappedImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
        }

        .image-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .upload-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .upload-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .file-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        .file-input::file-selector-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .detection-display {
            text-align: center;
            padding: 20px;
        }

        .expression {
            font-size: 4rem;
            margin-bottom: 20px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .expression-text {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: capitalize;
            transition: all 0.2s ease;
        }

        .confidence {
            font-size: 1.4rem;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .status {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .speech-indicator {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            padding: 15px;
            border-radius: 25px;
            margin: 15px 0;
            font-weight: bold;
            animation: pulse 1s infinite;
            font-size: 1.2rem;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .performance {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .performance-item {
            text-align: center;
            padding: 10px;
        }

        .performance-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .performance-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .landmark-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
        }

        .dot-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .dot.active {
            transform: scale(1.4);
        }

        .logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fast-indicator {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #44a08d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .image-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .image-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .image-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .image-item.active {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid #4CAF50;
        }

        .transform-info {
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Face Mapper Pro</h1>
            <p>Live Facial Movement Mapping - Upload any face and mirror your expressions in real-time</p>
        </div>

        <div class="main-content">
            <div class="camera-section">
                <h2 class="section-title">üìπ Live Camera & Image Mapping</h2>
                
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" class="canvas-overlay"></canvas>
                </div>

                <div class="image-preview-container">
                    <img id="mappedImage" style="display: none;">
                    <div id="imagePlaceholder" class="image-placeholder">
                        <div>üìÅ</div>
                        <div>Upload a face image to see it mirror your movements</div>
                    </div>
                </div>

                <div class="upload-section">
                    <h3>üñºÔ∏è Upload Face Image</h3>
                    <div class="upload-controls">
                        <div class="file-input-wrapper">
                            <input type="file" id="imageUpload" class="file-input" accept="image/*" />
                        </div>
                        <button id="uploadBtn" class="btn btn-primary">Upload Image</button>
                        <button id="clearImageBtn" class="btn btn-warning">Clear Image</button>
                    </div>
                    
                    <div class="image-list" id="imageList">
                        <!-- Uploaded images will appear here -->
                    </div>
                </div>

                <div class="controls">
                    <button id="startBtn" class="btn btn-primary">Start Mapping</button>
                    <button id="stopBtn" class="btn btn-danger" disabled>Stop Mapping</button>
                </div>

                <div class="performance">
                    <div class="performance-item">
                        <div class="performance-value" id="fpsCounter">0 FPS</div>
                        <div class="performance-label">Mapping Speed</div>
                    </div>
                    <div class="performance-item">
                        <div class="performance-value" id="detectionTime">0ms</div>
                        <div class="performance-label">Processing Time</div>
                    </div>
                    <div class="performance-item">
                        <div class="performance-value" id="landmarkCount">0</div>
                        <div class="performance-label">Landmarks</div>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Loading Advanced Face Mapping System...</p>
                </div>
            </div>

            <div class="detection-section">
                <h2 class="section-title">üîç Real-time Analysis & Controls</h2>
                <div class="detection-display">
                    <div class="expression" id="expressionEmoji">üòê</div>
                    <div class="expression-text" id="expressionText">Neutral</div>
                    <div class="confidence" id="confidenceText">Confidence: 0%</div>
                    
                    <div id="speechIndicator" class="speech-indicator" style="display: none;">
                        üó£Ô∏è SPEAKING DETECTED - Mouth Movement Active!
                    </div>
                    
                    <div class="status" id="statusText">Ready for face mapping - Upload an image to start</div>

                    <div class="transform-info" id="transformInfo">
                        <strong>Image Transformation:</strong><br>
                        Position: <span id="transformPosition">0, 0</span><br>
                        Scale: <span id="transformScale">100%</span><br>
                        Rotation: <span id="transformRotation">0¬∞</span>
                    </div>
                    
                    <div class="performance">
                        <div class="performance-item">
                            <div class="performance-value" id="mouthOpenness">0%</div>
                            <div class="performance-label">Mouth Open</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="headTurn">Center</div>
                            <div class="performance-label">Head Position</div>
                        </div>
                        <div class="performance-item">
                            <div class="performance-value" id="mappingActive">No</div>
                            <div class="performance-label">Image Mapping</div>
                        </div>
                    </div>

                    <div class="landmark-info">
                        <h3>üî¥ Facial Landmark System</h3>
                        <p>Red dots show key facial points. Green = Active, Orange = Speaking</p>
                        <div class="dot-grid" id="dotGrid">
                            <!-- Dots will be generated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="logs">
                        <h3>Activity Log</h3>
                        <div id="logContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Face Mapper Pro | Real-time Facial Movement Mapping | Upload & Mirror Any Face</p>
        </div>
    </div>

    <!-- Include TensorFlow.js and FaceAPI from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.1/dist/face-landmarks-detection.min.js"></script>

    <script>
        // Global variables for advanced face mapping
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let model = null;
        let isDetecting = false;
        let detectionInterval = null;
        let currentSessionId = null;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let fps = 0;

        // Image mapping variables
        let currentImage = null;
        let currentImageId = null;
        let uploadedImages = [];
        let faceTransform = {
            x: 0,
            y: 0,
            scale: 1,
            rotation: 0,
            flip: false
        };

        // Performance monitoring
        let detectionStartTime = 0;
        let totalDetectionTime = 0;
        let detectionCount = 0;

        // Speech detection
        let isSpeaking = false;
        let mouthOpennessHistory = [];

        // DOM elements
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const loading = document.getElementById('loading');
        const expressionEmoji = document.getElementById('expressionEmoji');
        const expressionText = document.getElementById('expressionText');
        const confidenceText = document.getElementById('confidenceText');
        const statusText = document.getElementById('statusText');
        const logContainer = document.getElementById('logContainer');
        const fpsCounter = document.getElementById('fpsCounter');
        const detectionTime = document.getElementById('detectionTime');
        const landmarkCount = document.getElementById('landmarkCount');
        const speechIndicator = document.getElementById('speechIndicator');
        const mouthOpenness = document.getElementById('mouthOpenness');
        const headTurn = document.getElementById('headTurn');
        const mappingActive = document.getElementById('mappingActive');
        const dotGrid = document.getElementById('dotGrid');
        const imageUpload = document.getElementById('imageUpload');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const mappedImage = document.getElementById('mappedImage');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const imageList = document.getElementById('imageList');
        const transformInfo = document.getElementById('transformInfo');
        const transformPosition = document.getElementById('transformPosition');
        const transformScale = document.getElementById('transformScale');
        const transformRotation = document.getElementById('transformRotation');

        // Enhanced expression mapping
        const expressionMap = {
            'neutral': 'üòê',
            'happy': 'üòä',
            'very_happy': 'üòÑ',
            'sad': 'üò¢',
            'very_sad': 'üò≠',
            'angry': 'üò†',
            'fearful': 'üò®',
            'disgusted': 'ü§¢',
            'surprised': 'üò≤',
            'blink': 'üòë',
            'leftTurn': 'üëà',
            'rightTurn': 'üëâ',
            'up': 'üëÜ',
            'down': 'üëá',
            'smirk': 'üòè',
            'wink': 'üòâ',
            'speaking': 'üó£Ô∏è',
            'listening': 'üëÇ'
        };

        // Initialize dot grid for landmark visualization
        function initializeDotGrid() {
            dotGrid.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.id = `dot-${i}`;
                dotGrid.appendChild(dot);
            }
        }

        // Update dot grid based on facial activity
        function updateDotGrid(activityLevel, isSpeaking) {
            const dots = document.querySelectorAll('.dot');
            const activeCount = Math.floor(activityLevel * dots.length);
            
            dots.forEach((dot, index) => {
                if (index < activeCount) {
                    dot.classList.add('active');
                    if (isSpeaking) {
                        dot.style.background = '#ffaa00'; // Orange for speaking
                    } else {
                        dot.style.background = '#00ff00'; // Green for active
                    }
                } else {
                    dot.classList.remove('active');
                    dot.style.background = '#ff4444'; // Red for inactive
                }
            });
        }

        // Load uploaded images from server
        async function loadUploadedImages() {
            try {
                const response = await fetch('/uploaded-images');
                const data = await response.json();
                
                if (data.success) {
                    uploadedImages = data.images;
                    updateImageList();
                }
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        // Update image list in UI
        function updateImageList() {
            imageList.innerHTML = '';
            
            uploadedImages.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                if (image.id === currentImageId) {
                    imageItem.classList.add('active');
                }
                
                imageItem.innerHTML = `
                    <span>üì∑ ${image.filename}</span>
                    <button onclick="selectImage('${image.id}', '${image.url}')" class="btn" style="padding: 5px 10px; font-size: 0.8rem;">Select</button>
                `;
                
                imageList.appendChild(imageItem);
            });
        }

        // Select image for mapping
        function selectImage(imageId, imageUrl) {
            currentImageId = imageId;
            mappedImage.src = imageUrl;
            mappedImage.style.display = 'block';
            imagePlaceholder.style.display = 'none';
            
            // Update image list to show active image
            updateImageList();
            
            log(`üñºÔ∏è Image selected for mapping: ${imageId}`);
            statusText.textContent = 'Image loaded - Ready for face mapping!';
        }

        // Clear current image
        function clearImage() {
            currentImageId = null;
            mappedImage.style.display = 'none';
            imagePlaceholder.style.display = 'flex';
            updateImageList();
            log('üóëÔ∏è Image cleared');
        }

        // Upload image
        async function uploadImage() {
            const file = imageUpload.files[0];
            if (!file) {
                alert('Please select an image file first');
                return;
            }

            const formData = new FormData();
            formData.append('faceImage', file);

            try {
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Uploading...';

                const response = await fetch('/upload-face', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    log(`‚úÖ Image uploaded: ${data.filename}`);
                    await loadUploadedImages();
                    selectImage(data.imageId, data.imageUrl);
                    imageUpload.value = ''; // Clear file input
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                log(`‚ùå Upload failed: ${error.message}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Image';
            }
        }

        // Initialize camera with optimized settings
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user',
                        frameRate: { ideal: 30 }
                    } 
                });
                video.srcObject = stream;
                
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                });
                
                log('üìπ Camera ready - Face mapping enabled');
                return true;
            } catch (error) {
                log('‚ùå Camera error: ' + error.message, 'error');
                return false;
            }
        }

        // Load optimized face detection model
        async function loadModel() {
            try {
                loading.style.display = 'block';
                statusText.textContent = 'Loading Advanced Face Mapping System...';
                
                model = await faceLandmarksDetection.load(
                    faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
                    { 
                        maxFaces: 1,
                        refineLandmarks: true,
                        detectionFlips: false
                    }
                );
                
                loading.style.display = 'none';
                statusText.textContent = '‚ö° Face Mapping System Ready!';
                log('‚úÖ Advanced face mapping model loaded');
                return true;
            } catch (error) {
                loading.style.display = 'none';
                log('‚ùå Model load error: ' + error.message, 'error');
                statusText.textContent = 'Failed to load model';
                return false;
            }
        }

        // Start advanced mapping session
        async function startMapping() {
            try {
                const response = await fetch('/start-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageId: currentImageId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentSessionId = data.sessionId;
                    isDetecting = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusText.textContent = '‚ö° Face Mapping Active!';
                    mappingActive.textContent = currentImageId ? 'Yes' : 'No';
                    log(`üöÄ Face mapping started${currentImageId ? ' with image mapping' : ''}`);
                    
                    detectFaces();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                log('‚ùå Start error: ' + error.message, 'error');
            }
        }

        // Stop mapping
        async function stopMapping() {
            isDetecting = false;
            cancelAnimationFrame(detectionInterval);
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusText.textContent = 'Mapping stopped';
            speechIndicator.style.display = 'none';
            mappingActive.textContent = 'No';
            
            if (currentSessionId) {
                try {
                    await fetch('/end-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId: currentSessionId })
                    });
                    log('üìä Mapping session ended');
                } catch (error) {
                    log('‚ùå End session error: ' + error.message, 'error');
                }
                currentSessionId = null;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            resetDisplay();
            updateDotGrid(0, false);
            resetImageTransform();
        }

        // Reset image transform
        function resetImageTransform() {
            faceTransform = { x: 0, y: 0, scale: 1, rotation: 0, flip: false };
            updateTransformDisplay();
        }

        // Update transform display
        function updateTransformDisplay() {
            transformPosition.textContent = `${Math.round(faceTransform.x)}, ${Math.round(faceTransform.y)}`;
            transformScale.textContent = `${Math.round(faceTransform.scale * 100)}%`;
            transformRotation.textContent = `${Math.round(faceTransform.rotation)}¬∞`;
        }

        // Reset display to neutral
        function resetDisplay() {
            expressionEmoji.textContent = 'üòê';
            expressionText.textContent = 'Neutral';
            confidenceText.textContent = 'Confidence: 0%';
            mouthOpenness.textContent = '0%';
            headTurn.textContent = 'Center';
        }

        // Advanced face detection with image mapping
        async function detectFaces() {
            if (!model || !isDetecting) return;
            
            detectionStartTime = performance.now();
            frameCount++;
            
            try {
                const predictions = await model.estimateFaces({
                    input: video,
                    returnTensors: false,
                    flipHorizontal: false,
                    predictIrises: true
                });
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (predictions.length > 0) {
                    const face = predictions[0];
                    drawAdvancedLandmarks(face);
                    
                    const analysis = analyzeFaceWithMapping(face);
                    updateDisplayWithMapping(analysis);
                    updateImageTransform(analysis);
                    sendDetectionToServer(analysis);
                    
                    landmarkCount.textContent = face.scaledMesh.length;
                    updateDotGrid(analysis.activityLevel, analysis.isSpeaking);
                } else {
                    statusText.textContent = '‚ö° No face detected';
                    resetDisplay();
                    updateDotGrid(0, false);
                    resetImageTransform();
                }
                
                updatePerformanceMetrics();
                
            } catch (error) {
                if (error.message !== 'Cancelled') {
                    log('‚ö†Ô∏è Detection glitch: ' + error.message, 'error');
                }
            }
            
            if (isDetecting) {
                detectionInterval = requestAnimationFrame(detectFaces);
            }
        }

        // Update image transform based on face analysis
        function updateImageTransform(analysis) {
            if (!currentImageId) return;

            // Calculate transform based on head position and movements
            const headPos = analysis.headPosition.toLowerCase();
            
            switch (headPos) {
                case 'left':
                    faceTransform.x = -20;
                    faceTransform.rotation = -5;
                    break;
                case 'right':
                    faceTransform.x = 20;
                    faceTransform.rotation = 5;
                    break;
                case 'up':
                    faceTransform.y = -15;
                    break;
                case 'down':
                    faceTransform.y = 15;
                    break;
                default:
                    faceTransform.x = 0;
                    faceTransform.y = 0;
                    faceTransform.rotation = 0;
            }

            // Scale based on mouth openness (for speaking effect)
            if (analysis.isSpeaking) {
                faceTransform.scale = 1 + (analysis.mouthOpenness / 100) * 0.1;
            } else {
                faceTransform.scale = 1;
            }

            // Apply transform to image
            mappedImage.style.transform = `
                translate(${faceTransform.x}px, ${faceTransform.y}px)
                scale(${faceTransform.scale})
                rotate(${faceTransform.rotation}deg)
                scaleX(${faceTransform.flip ? -1 : 1})
            `;

            updateTransformDisplay();
        }

        // Draw advanced facial landmarks
        function drawAdvancedLandmarks(face) {
            const landmarks = face.scaledMesh;
            const boundingBox = face.boundingBox;
            
            // Draw bounding box
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(
                boundingBox.topLeft[0],
                boundingBox.topLeft[1],
                boundingBox.bottomRight[0] - boundingBox.topLeft[0],
                boundingBox.bottomRight[1] - boundingBox.topLeft[1]
            );
            
            // Draw key facial points as red dots
            ctx.fillStyle = '#ff0000';
            
            const keyPoints = [
                // Eyes
                33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246,
                362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398,
                // Eyebrows, Nose, Mouth, Face contour
                55, 65, 52, 53, 46, 285, 295, 282, 283, 276, 1, 2, 98, 327,
                61, 84, 17, 314, 405, 320, 307, 81, 82, 13, 312, 311, 310, 415, 95, 88,
                78, 191, 80, 81, 82, 87, 14, 317, 402, 318, 324, 308,
                10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288, 397, 365, 379, 378, 400
            ];
            
            keyPoints.forEach(index => {
                if (landmarks[index]) {
                    const point = landmarks[index];
                    ctx.beginPath();
                    ctx.arc(point[0], point[1], 2, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
            
            // Draw mouth outline for speech visualization
            drawMouthOutline(landmarks);
        }

        // Draw mouth outline for speech detection
        function drawMouthOutline(landmarks) {
            const mouthPoints = [61, 84, 17, 314, 405, 320, 307, 81, 82, 13, 312, 311, 310, 415, 95, 88, 78];
            
            ctx.strokeStyle = isSpeaking ? '#ffaa00' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            mouthPoints.forEach((index, i) => {
                const point = landmarks[index];
                if (point) {
                    if (i === 0) {
                        ctx.moveTo(point[0], point[1]);
                    } else {
                        ctx.lineTo(point[0], point[1]);
                    }
                }
            });
            
            ctx.closePath();
            ctx.stroke();
        }

        // Advanced facial analysis with mapping data
        function analyzeFaceWithMapping(face) {
            const landmarks = face.scaledMesh;
            
            // Get key points
            const noseTip = landmarks[1];
            const mouthLeft = landmarks[61];
            const mouthRight = landmarks[291];
            const mouthTop = landmarks[13];
            const mouthBottom = landmarks[14];
            const leftEye = landmarks[33];
            const rightEye = landmarks[263];
            const leftEyebrow = landmarks[65];
            const rightEyebrow = landmarks[295];
            
            let expression = 'neutral';
            let confidence = 0.8;
            let additionalInfo = 'Face detected';
            let activityLevel = 0;
            let headPosition = 'Center';
            
            // Calculate mouth openness for speech detection
            const mouthWidth = Math.abs(mouthRight[0] - mouthLeft[0]);
            const mouthHeight = Math.abs(mouthBottom[1] - mouthTop[1]);
            const currentMouthOpenness = (mouthHeight / mouthWidth) * 100;
            
            // Update mouth openness history for speech detection
            mouthOpennessHistory.push(currentMouthOpenness);
            if (mouthOpennessHistory.length > 10) {
                mouthOpennessHistory.shift();
            }
            
            // Speech detection logic
            const avgMouthOpenness = mouthOpennessHistory.reduce((a, b) => a + b) / mouthOpennessHistory.length;
            const mouthOpennessVariation = Math.max(...mouthOpennessHistory) - Math.min(...mouthOpennessHistory);
            
            isSpeaking = avgMouthOpenness > 15 && mouthOpennessVariation > 5;
            
            if (isSpeaking) {
                expression = 'speaking';
                confidence = 0.9;
                additionalInfo = 'SPEAKING DETECTED - Image will scale with mouth movement';
                activityLevel = 0.8;
            }
            // Enhanced expression detection
            else {
                const smileIntensity = (mouthWidth / 80) + (mouthHeight / 20);
                
                if (smileIntensity > 2.5) {
                    expression = 'very_happy';
                    confidence = Math.min(0.95, smileIntensity / 3);
                    additionalInfo = 'BIG SMILE!';
                    activityLevel = 0.7;
                } else if (smileIntensity > 1.8) {
                    expression = 'happy';
                    confidence = Math.min(0.85, smileIntensity / 2.5);
                    additionalInfo = 'Smiling detected';
                    activityLevel = 0.6;
                }
                // Sad detection
                else {
                    const eyebrowAngle = (leftEyebrow[1] - landmarks[65][1]) + (rightEyebrow[1] - landmarks[295][1]);
                    const mouthCornersDown = (mouthLeft[1] - landmarks[61][1]) + (mouthRight[1] - landmarks[291][1]);
                    
                    if (eyebrowAngle > 10 && mouthCornersDown > 5) {
                        expression = 'very_sad';
                        confidence = 0.8;
                        additionalInfo = 'SAD expression';
                        activityLevel = 0.6;
                    } else if (eyebrowAngle > 5) {
                        expression = 'sad';
                        confidence = 0.7;
                        additionalInfo = 'Slightly sad';
                        activityLevel = 0.5;
                    }
                }
            }
            
            // Head movement detection
            if (noseTip[0] < canvas.width * 0.35) {
                expression = 'leftTurn';
                headPosition = 'Left';
                activityLevel = 0.9;
                additionalInfo = 'Head LEFT - Image will shift left';
            } else if (noseTip[0] > canvas.width * 0.65) {
                expression = 'rightTurn';
                headPosition = 'Right';
                activityLevel = 0.9;
                additionalInfo = 'Head RIGHT - Image will shift right';
            } else if (noseTip[1] < canvas.height * 0.35) {
                expression = 'up';
                headPosition = 'Up';
                activityLevel = 0.7;
                additionalInfo = 'Looking UP - Image will shift up';
            } else if (noseTip[1] > canvas.height * 0.65) {
                expression = 'down';
                headPosition = 'Down';
                activityLevel = 0.7;
                additionalInfo = 'Looking DOWN - Image will shift down';
            }
            
            return {
                expression: expression,
                confidence: confidence,
                additionalInfo: additionalInfo,
                landmarks: landmarks.slice(0, 10),
                isSpeaking: isSpeaking,
                mouthOpenness: currentMouthOpenness,
                headPosition: headPosition,
                activityLevel: activityLevel,
                faceTransform: faceTransform
            };
        }

        // Enhanced display update with mapping info
        function updateDisplayWithMapping(analysis) {
            const emoji = expressionMap[analysis.expression] || 'üòê';
            const expressionName = analysis.expression.replace('_', ' ').toUpperCase();
            
            expressionEmoji.textContent = emoji;
            expressionText.textContent = expressionName;
            confidenceText.textContent = `Confidence: ${Math.round(analysis.confidence * 100)}%`;
            statusText.textContent = analysis.additionalInfo;
            mouthOpenness.textContent = `${Math.round(analysis.mouthOpenness)}%`;
            headTurn.textContent = analysis.headPosition;
            mappingActive.textContent = currentImageId ? 'Yes' : 'No';
            
            // Speech indicator
            if (analysis.isSpeaking) {
                speechIndicator.style.display = 'block';
                expressionEmoji.style.transform = 'scale(1.2)';
                expressionText.style.color = '#ffaa00';
            } else {
                speechIndicator.style.display = 'none';
                expressionEmoji.style.transform = 'scale(1)';
                expressionText.style.color = 'white';
            }
        }

        // Send enhanced detection to server
        async function sendDetectionToServer(analysis) {
            if (!currentSessionId) return;
            
            fetch('/detect-expression', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: currentSessionId,
                    expression: analysis.expression,
                    confidence: analysis.confidence,
                    landmarks: analysis.landmarks,
                    isSpeaking: analysis.isSpeaking,
                    mouthOpenness: analysis.mouthOpenness,
                    headPosition: analysis.headPosition,
                    faceTransform: analysis.faceTransform
                })
            }).catch(() => {});
        }

        // Performance monitoring
        function updatePerformanceMetrics() {
            const now = Date.now();
            const currentDetectionTime = performance.now() - detectionStartTime;
            
            totalDetectionTime += currentDetectionTime;
            detectionCount++;
            
            if (now - lastFpsUpdate >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFpsUpdate = now;
                
                const avgDetectionTime = totalDetectionTime / detectionCount;
                
                fpsCounter.textContent = `${fps} FPS`;
                detectionTime.textContent = `${avgDetectionTime.toFixed(1)}ms`;
                
                totalDetectionTime = 0;
                detectionCount = 0;
            }
        }

        // Fast logging
        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            if (type === 'error') {
                logEntry.style.color = '#ff6b6b';
            } else if (type === 'success') {
                logEntry.style.color = '#51cf66';
            }
            
            logContainer.appendChild(logEntry);
            
            if (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.firstChild);
            }
            
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Event listeners
        startBtn.addEventListener('click', startMapping);
        stopBtn.addEventListener('click', stopMapping);
        uploadBtn.addEventListener('click', uploadImage);
        clearImageBtn.addEventListener('click', clearImage);

        // Advanced initialization
        async function init() {
            log('üöÄ Initializing Face Mapper Pro...');
            initializeDotGrid();
            await loadUploadedImages();
            
            const cameraReady = await initCamera();
            if (!cameraReady) return;
            
            const modelReady = await loadModel();
            if (!modelReady) return;
            
            log('‚úÖ READY! Upload a face image and start mapping your movements');
            statusText.textContent = '‚ö° Ready - Upload an image and start mapping';
        }

        // Start the advanced application
        init();
    </script>
</body>
</html>

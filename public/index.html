<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Talking Photo Animator - Real Lip Movement</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      padding: 40px 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 25px;
      backdrop-filter: blur(15px);
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .header h1 {
      font-size: 3.5rem;
      background: linear-gradient(45deg, #ff9a9e, #fad0c4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .header p { font-size: 1.3rem; opacity: 0.9; }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }
    @media (max-width: 968px) {
      .main-content { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      padding: 30px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    }
    .card h2 {
      font-size: 1.8rem;
      color: #a29bfe;
      margin-bottom: 20px;
      text-align: center;
    }

    .upload-area {
      border: 3px dashed rgba(255,255,255,0.4);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .upload-area:hover {
      border-color: #a29bfe;
      background: rgba(162, 155, 254, 0.1);
    }
    .upload-area input { display: none; }
    .upload-area label {
      font-size: 1.3rem;
      cursor: pointer;
      color: #ddd;
    }

    .image-box {
      margin-top: 20px;
      border-radius: 20px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .image-box img, .image-box canvas {
      width: 100%;
      height: auto;
      max-height: 500px;
      object-fit: contain;
      display: block;
    }
    .placeholder {
      height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 1.4rem;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      flex-wrap: wrap;
    }
    .btn {
      padding: 14px 32px;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn-start { background: #6c5ce7; }
    .btn-stop { background: #e17055; }
    .btn-reset { background: #fdcb6e; color: #333; }
    .btn:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

    .status-bar {
      text-align: center;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      margin-top: 20px;
      font-size: 1.1rem;
    }

    .loading {
      text-align: center;
      padding: 30px;
      display: none;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 5px solid #333;
      border-top: 5px solid #a29bfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Talking Photo Animator</h1>
      <p>Upload any face photo â†’ Watch it talk with real lip movement</p>
    </div>

    <div class="main-content">
      <!-- Upload Section -->
      <div class="card">
        <h2>Upload Photo</h2>
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept="image/*" />
          <label for="fileInput">Click or Drop Image Here</label>
        </div>

        <div class="image-box">
          <img id="uploadedImage" style="display:none;" />
          <div class="placeholder" id="uploadPlaceholder">
            <div>No image uploaded yet</div>
          </div>
        </div>

        <div class="status-bar" id="statusText">Ready to upload</div>
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Detecting face & preparing animation...</p>
        </div>
      </div>

      <!-- Animation Section -->
      <div class="card">
        <h2>Animated Result</h2>
        <div class="image-box">
          <canvas id="animatedCanvas"></canvas>
          <div class="placeholder" id="animPlaceholder">
            <div>Animation will appear here</div>
          </div>
        </div>

        <div class="controls">
          <button id="startBtn" class="btn btn-start" disabled>Start Talking</button>
          <button id="stopBtn" class="btn btn-stop" disabled>Stop</button>
          <button id="resetBtn" class="btn btn-reset">Reset</button>
        </div>

        <div class="status-bar">
          Mouth Open: <strong id="mouthOpenness">0%</strong> | 
          Status: <strong id="animState">Stopped</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- TensorFlow.js + Face Mesh -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.3"></script>

  <script>
    const canvas = document.getElementById('animatedCanvas');
    const ctx = canvas.getContext('2d');
    const uploadedImg = document.getElementById('uploadedImage');
    const fileInput = document.getElementById('fileInput');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusText = document.getElementById('statusText');
    const loading = document.getElementById('loading');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const animPlaceholder = document.getElementById('animPlaceholder');

    let model, originalImage = null, landmarks = null;
    let isAnimating = false;
    let mouthOpenness = 0;

    // Key mouth landmarks (MediaPipe FaceMesh)
    const MOUTH_INNER = [13, 14, 78, 308, 324, 318, 402, 317, 87, 178];
    const UPPER_LIP = [0, 267, 269, 270, 409, 291, 375, 321, 405, 314];
    const LOWER_LIP = [17, 84, 181, 91, 146, 61, 185, 39, 40, 37];

    // Professional Thin-Plate-Spline-like warping
    function warpMouth(openness) {
      if (!landmarks || !originalImage) return;

      const points = landmarks.scaledMesh;
      ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const output = ctx.createImageData(canvas.width, canvas.height);

      const centerX = points[1][0];
      const centerY = points[1][1];

      for (let y = 0; y < canvas.height; y += 1) {
        for (let x = 0; x < canvas.width; x += 1) {
          let srcX = x;
          let srcY = y;

          const dist = Math.hypot(x - centerX, y - centerY);
          if (dist < 140) {
            let displacementY = 0;

            // Upper lip down slightly
            if (y < centerY - 10) {
              displacementY = openness * 18;
            }
            // Lower lip down more
            else if (y > centerY + 10) {
              displacementY = openness * 45;
            }
            // Inner mouth area
            else {
              displacementY = openness * 35;
            }

            srcY += displacementY * (1 - dist / 140);
          }

          srcX = Math.max(0, Math.min(canvas.width - 1, srcX));
          srcY = Math.max(0, Math.min(canvas.height - 1, srcY));

          const i = (y * canvas.width + x) * 4;
          const si = (Math.floor(srcY) * canvas.width + Math.floor(srcX)) * 4;

          output.data[i]   = imageData.data[si];
          output.data[i+1] = imageData.data[si+1];
          output.data[i+2] = imageData.data[si+2];
          output.data[i+3] = imageData.data[si+3];
        }
      }

      ctx.putImageData(output, 0, 0);
    }

    function animate() {
      if (!isAnimating) return;

      const time = performance.now() * 0.003;
      mouthOpenness = (Math.sin(time * 6) + 1) / 2 * 0.8 + 0.2;

      ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      warpMouth(mouthOpenness);

      document.getElementById('mouthOpenness').textContent = Math.round(mouthOpenness * 100) + '%';
      requestAnimationFrame(animate);
    }

    async function processImage(file) {
      loading.style.display = 'block';
      statusText.textContent = 'Uploading & detecting face...';

      const formData = new FormData();
      formData.append('faceImage', file);

      const res = await fetch('/upload-face', { method: 'POST', body: formData });
      const data = await res.json();

      if (!data.success) throw new Error('Upload failed');

      const img = new Image();
      img.onload = async () => {
        // Resize canvas
        const maxSize = 600;
        const ratio = Math.min(maxSize / img.width, maxSize / img.height);
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;

        uploadedImg.src = img.src;
        uploadedImg.style.display = 'block';
        uploadPlaceholder.style.display = 'none';
        animPlaceholder.style.display = 'none';
        canvas.style.display = 'block';
        originalImage = img;

        // Load model & detect face
        model = model || await faceLandmarksDetection.load(
          faceLandmarksDetection.SupportedPackages.mediapipeFacemesh
        );

        const faces = await model.estimateFaces({ input: img });
        if (faces.length === 0) throw new Error('No face detected!');

        landmarks = faces[0];
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        startBtn.disabled = false;
        statusText.textContent = 'Ready! Click "Start Talking"';
        loading.style.display = 'none';
      };
      img.src = data.imageUrl;
    }

    // Event Listeners
    fileInput.onchange = () => {
      if (fileInput.files[0]) processImage(fileInput.files[0]).catch(e => {
        alert(e.message);
        loading.style.display = 'none';
      });
    };

    startBtn.onclick = () => {
      isAnimating = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      document.getElementById('animState').textContent = 'Talking';
      animate();
    };

    stopBtn.onclick = () => {
      isAnimating = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      document.getElementById('animState').textContent = 'Stopped';
      if (originalImage) ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
    };

    resetBtn.onclick = () => {
      stopBtn.click();
      document.getElementById('mouthOpenness').textContent = '0%';
    };
  </script>
</body>
</html>

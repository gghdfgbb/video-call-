<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Talking Photo Animator - Real Mouth Movement</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: white;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header {
      text-align: center; padding: 30px; background: rgba(255,255,255,0.1);
      border-radius: 20px; backdrop-filter: blur(10px); margin-bottom: 30px;
    }
    .header h1 {
      font-size: 3rem; background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    @media (max-width: 968px) { .main-content { grid-template-columns: 1fr; } }

    .section {
      background: rgba(255,255,255,0.08); backdrop-filter: blur(12px);
      border-radius: 20px; padding: 25px; border: 1px solid rgba(255,255,255,0.2);
    }
    .section-title { font-size: 1.6rem; color: #4ecdc4; margin-bottom: 20px; text-align: center; }

    .image-container {
      position: relative; background: #000; border-radius: 15px; overflow: hidden;
      margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    #uploadedImage, #animatedCanvas {
      width: 100%; height: auto; max-height: 500px; object-fit: contain; display: none;
    }
    .placeholder {
      height: 400px; display: flex; flex-direction: column; align-items: center;
      justify-content: center; color: #aaa; font-size: 1.2rem;
    }

    .btn {
      padding: 14px 28px; border: none; border-radius: 50px; font-weight: bold;
      cursor: pointer; transition: 0.3s; margin: 8px; text-transform: uppercase;
    }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-primary:hover { background: #45a049; transform: translateY(-3px); }
    .btn-danger { background: #f44336; color: white; }
    .btn-warning { background: #ff9800; color: white; }

    .controls { text-align: center; margin: 20px 0; }
    .status { padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center; }

    .spinner {
      border: 4px solid #333; border-top: 4px solid #4ecdc4; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Talking Photo Animator</h1>
      <p>Upload any face â†’ Watch it talk with real mouth movement!</p>
    </div>

    <div class="main-content">
      <div class="section">
        <h2 class="section-title">Upload Face</h2>
        <input type="file" id="imageUpload" accept="image/*" style="display:block; margin:20px auto; padding:10px;" />
        <button id="uploadBtn" class="btn btn-primary">Upload & Process</button>

        <div class="image-container">
          <img id="uploadedImage" alt="Your face" />
          <div class="placeholder">Upload a clear face photo</div>
        </div>

        <div class="status" id="statusText">Ready</div>
        <div id="loading" style="display:none;"><div class="spinner"></div><p>Detecting face & preparing animation...</p></div>
      </div>

      <div class="section">
        <h2 class="section-title">Animated Result</h2>
        <div class="image-container">
          <canvas id="animatedCanvas"></canvas>
          <div class="placeholder">Animation will appear here</div>
        </div>

        <div class="controls">
          <button id="startBtn" class="btn btn-primary" disabled>Start Talking</button>
          <button id="stopBtn" class="btn btn-danger" disabled>Stop</button>
          <button id="resetBtn" class="btn btn-warning">Reset</button>
        </div>

        <div class="status">
          Mouth Open: <strong id="mouthOpenness">0%</strong> | 
          State: <strong id="animationState">Stopped</strong> | 
          FPS: <strong id="frameRate">0</strong>
        </div>
      </div>
    </div>
  </div>

  <!-- TensorFlow.js + Face Mesh -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.1"></script>

  <script>
    // Global vars
    let originalImage = null;
    let faceLandmarks = null;
    let baseLandmarks = null;
    let isAnimating = false;
    let animationFrame = null;
    let frameCount = 0;
    let lastFpsTime = 0;

    const canvas = document.getElementById('animatedCanvas');
    const ctx = canvas.getContext('2d');
    const uploadedImg = document.getElementById('uploadedImage');

    // Elements
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('imageUpload');
    const statusText = document.getElementById('statusText');
    const loading = document.getElementById('loading');

    // Realistic mouth deformation
    function deformMouthRealistically(openness) {
      if (!originalImage || !baseLandmarks) return;

      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const newData = ctx.createImageData(canvas.width, canvas.height);
      const w = canvas.width, h = canvas.height;

      // Mouth region bounds
      const mouthTop = Math.min(...baseLandmarks.slice(0, 468).map(p => p[1])) * 0.9;
      const mouthBottom = Math.max(...baseLandmarks.slice(0, 468).map(p => p[1])) * 1.1;
      const mouthLeft = Math.min(...baseLandmarks.slice(0, 468).map(p => p[0])) * 0.9;
      const mouthRight = Math.max(...baseLandmarks.slice(0, 468).map(p => p[0])) * 1.1;

      const centerY = (mouthTop + mouthBottom) / 2;

      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          let srcX = x;
          let srcY = y;

          if (x > mouthLeft && x < mouthRight && y > mouthTop && y < mouthBottom) {
            const dy = y - centerY;
            const influence = 1 - Math.abs(dy) / ((mouthBottom - mouthTop) / 2);
            if (influence > 0) {
              const push = openness * 80 * influence;
              if (dy > 0) srcY += push; // lower lip down
              else srcY += push * 0.4; // upper lip slight down
            }
          }

          srcX = Math.max(0, Math.min(w - 1, srcX));
          srcY = Math.max(0, Math.min(h - 1, srcY));

          const i = (y * w + x) * 4;
          const si = (Math.floor(srcY) * w + Math.floor(srcX)) * 4;

          newData.data[i]   = imgData.data[si];
          newData.data[i+1] = imgData.data[si+1];
          newData.data[i+2] = imgData.data[si+2];
          newData.data[i+3] = imgData.data[si+3];
        }
      }

      ctx.putImageData(newData, 0, 0);

      // Draw teeth when open
      if (openness > 0.6) {
        const centerX = w / 2;
        const centerYPos = centerY + 20;
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        for (let i = 0; i < 8; i++) {
          const x = centerX - 30 + i * 8;
          ctx.fillRect(x, centerYPos - 8, 6, 16);
        }
      }
    }

    function animate() {
      if (!isAnimating) return;

      frameCount++;
      const now = performance.now();
      if (now - lastFpsTime > 1000) {
        document.getElementById('frameRate').textContent = frameCount + " FPS";
        frameCount = 0;
        lastFpsTime = now;
      }

      // Natural talking rhythm
      const time = now * 0.003;
      const openness = (Math.sin(time * 4) * 0.4 + Math.sin(time * 1.7) * 0.3 + 0.7);

      ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      deformMouthRealistically(openness);

      document.getElementById('mouthOpenness').textContent = Math.round(openness * 100) + "%";

      animationFrame = requestAnimationFrame(animate);
    }

    async function processImage(file) {
      loading.style.display = "block";
      statusText.textContent = "Uploading...";

      const form = new FormData();
      form.append("faceImage", file);

      const res = await fetch("/upload-face", { method: "POST", body: form });
      const data = await res.json();

      if (!data.success) throw new Error(data.error);

      const img = new Image();
      img.onload = async () => {
        // Resize canvas
        const max = 600;
        const ratio = Math.min(max / img.width, max / img.height);
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;

        uploadedImg.src = img.src;
        uploadedImg.style.display = "block";
        canvas.style.display = "block";
        originalImage = img;

        // Detect face
        statusText.textContent = "Detecting face...";
        const model = await faceLandmarksDetection.load(
          faceLandmarksDetection.SupportedPackages.mediapipeFacemesh
        );
        const faces = await model.estimateFaces({ input: img });

        if (faces.length === 0) throw new Error("No face found!");

        faceLandmarks = faces[0];
        baseLandmarks = JSON.parse(JSON.stringify(faces[0].scaledMesh));

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        startBtn.disabled = false;
        statusText.textContent = "Ready! Click Start Talking";
        loading.style.display = "none";
      };

      img.src = data.imageUrl;
    }

    // Event Listeners
    uploadBtn.onclick = () => {
      if (!fileInput.files[0]) return alert("Select an image first!");
      processImage(fileInput.files[0]).catch(err => {
        alert("Error: " + err.message);
        loading.style.display = "none";
      });
    };

    startBtn.onclick = () => {
      isAnimating = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      document.getElementById('animationState').textContent = "Talking";
      animate();
    };

    stopBtn.onclick = () => {
      isAnimating = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      document.getElementById('animationState').textContent = "Stopped";
      cancelAnimationFrame(animationFrame);
      if (originalImage) ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
    };

    resetBtn.onclick = () => {
      stopBtn.click();
      document.getElementById('mouthOpenness').textContent = "0%";
    };
  </script>
</body>
</html>
